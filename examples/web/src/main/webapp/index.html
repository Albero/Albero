<html>
	<head>
		<title>Albero</title>

		<link rel="stylesheet" type="text/css" href="styles/albero.css"/>

		<script type="text/javascript" src="scripts/json2.js"></script>
		<script type="text/javascript" src="scripts/albero.js"></script>
		<script type="text/javascript" src="scripts/albero-elements.js"></script>
		<script type="text/javascript" src="scripts/example-elements.js"></script>
		<script type="text/javascript" src="scripts/creole.js"></script>
	</head>

	<body>
		<div id="header_logo">
			&nbsp;
		</div>
		<div id="header">
			<span class="titel">Albero vragenboom demo</span>
		</div>
		<div id="kruimels">
			&nbsp;
		</div>

		<div class="menu"></div>				

		<div id="navigation"></div>

		<div class="content">
			<table id="context">
				<tbody id="context-body"></tbody>
			</table>		

			<div id="albero">
				<button id="start-button">Start!</button>
			</div>	
		</div> 

		<table id="results">
			<thead>
				<tr>
					<th>Overgenomen resultaat</th>
				</tr>
			</thead>

			<tbody id="results-body"></tbody>
		</table>

		<script type="text/javascript">
			var NO_PREVIOUS_NODE_GROUP = {};
			var previousNodeGroup = NO_PREVIOUS_NODE_GROUP;

			function clearNavigationAndBreadcrumbs() {
				nl.profict.albero.Utilities.clear(document.getElementById('navigation'));
				nl.profict.albero.Utilities.clear(document.getElementById('context-body'));
			}

			function updateNavigation(albero, complete) {
				var navigationBlock = document.getElementById('navigation');

				var nodeGroups = albero.getNodeGroups();
				var nodeGroup = albero.getNodeGroup();

				for (var i = 0; i < nodeGroups.length; i++) {
					if (i > 0) {
						navigationBlock.appendChild(document.createElement('br'));
					}

					if ((nodeGroup == nodeGroups[i]) && !complete) {
						var group = document.createElement('strong');
						group.appendChild(document.createTextNode(nodeGroups[i] || '-'));

						navigationBlock.appendChild(group);
					} else {
						navigationBlock.appendChild(document.createTextNode(nodeGroups[i] || '-'));
					}
				}
			}

			function addBreadcrumbs(albero) {
				var breadcrumbs = document.getElementById('context-body');

				var nodeGroup = albero.getNodeGroup();

				var nodes = albero.getNodes(nodeGroup);

				for (var i = 0; i < nodes.length - 1; i++) {
					var nodeBlock = document.createElement('div');
					nodeBlock.appendChild(createInformationBlock(albero,  nodeGroup, nodes[i]));
					breadcrumbs.appendChild(nodeBlock);
				}
			}

			function updateResults(albero) {
				var resultsBlock = document.getElementById('results-body');

				nl.profict.albero.Utilities.clear(resultsBlock);

				var results = albero.getResults();

				for (var name in results) {
					var row = document.createElement('tr');

					var nameCell = document.createElement('td');
					nameCell.innerHTML = name + ': ' + results[name]
					row.appendChild(nameCell);

					resultsBlock.appendChild(row);
				}
			}

			function summarise(nodeGroup, albero, callback) {
				var alberoBlock = document.getElementById('albero');

				var nodes = albero.getNodes(nodeGroup);

				for (var i = 0; i < nodes.length; i++) {
					var nodeBlock = document.createElement('div');
					nodeBlock.appendChild(createInformationBlock(albero, nodeGroup, nodes[i]));
					alberoBlock.appendChild(nodeBlock);
				}

				var button = document.createElement('button');
				button.appendChild(document.createTextNode('Ga verder'));

				nl.profict.albero.Utilities.addEventListener(button, 'click', function() {
					nl.profict.albero.Utilities.clear(document.getElementById('albero'));

					callback();
				});

				alberoBlock.appendChild(button);
			}

			function createInformationBlock(albero, nodeGroup, node) {
				var informationBlock = document.createElement('dl');

				var information = albero.getFormInformation(node);

				for (var j = 0; j < information.length; j++) {
					var labelBlock = document.createElement('dt');
					labelBlock.innerHTML = information[j].label;
					informationBlock.appendChild(labelBlock);

					var valueBlock = document.createElement('dd');
					valueBlock.appendChild(document.createTextNode(JSON.stringify(information[j].value))); // TODO renderer
					valueBlock.appendChild(document.createTextNode(' '));
					valueBlock.appendChild(createRevisitLink(albero, nodeGroup, node, 'Wijzig'));

					informationBlock.appendChild(valueBlock);
				}

				return informationBlock;
			}

			function createRevisitLink(albero, nodeGroup, node, text) {
				var link = document.createElement('a');
				link.href = '#' + node;
				link.appendChild(document.createTextNode(text));

				nl.profict.albero.Utilities.addEventListener(link, 'click', function() {
					previousNodeGroup = nodeGroup;

					albero.revisit(nodeGroup, node);
				});

				return link;
			}

			function formGuard(albero, render) {
				clearNavigationAndBreadcrumbs();

				updateResults(albero);

				var callback = function() {
					updateNavigation(albero, false);
					addBreadcrumbs(albero);

					render();
				};

				var nodeGroup = albero.getNodeGroup();

				if ((previousNodeGroup != NO_PREVIOUS_NODE_GROUP) && (nodeGroup != previousNodeGroup)) {
					summarise(previousNodeGroup, albero, callback);
				} else {
					callback();
				}

				previousNodeGroup = nodeGroup;
			}

			nl.profict.albero.Utilities.addEventListener(document.getElementById('start-button'), 'click', function() {
				var albero = new nl.profict.albero.Albero('http://' + location.host + '/proxy', 'demo', 'nl', 'random', {}, 'albero');

				nl.profict.albero.elements.ElementFactories.addDefaultElementFactories(albero);
				albero.addElementFactory('data list', example.elements.DataList);

				albero.addListener({
					onForm: function() {},

					onComplete: function() {
						clearNavigationAndBreadcrumbs();

						updateResults(albero);

						summarise(previousNodeGroup, albero, function() {
							clearNavigationAndBreadcrumbs();
							updateNavigation(albero, true);

							document.getElementById('albero').appendChild(document.createTextNode('U bent nu klaar.'));
						});
					}
				});

				albero.setFormGuard(formGuard);

				albero.setTextRenderer(function(text) {
					var element = document.createElement('div');
					new Parse.Simple.Creole().parse(element, text);
					return element.innerHTML.replace(/^<p>(.*)<\/p>$/, '$1');
				});

				albero.refresh();
			});
		</script>
	</body>
</html>
